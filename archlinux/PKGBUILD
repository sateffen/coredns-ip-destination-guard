# based on: https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=coredns
pkgname=coredns-ip-destination-guard
pkgver=1.13.2
pkgrel=1
pkgdesc="CoreDNS IP-Destination-Guard DNS server"
depends=('nftables')
makedepends=('go' 'make')
arch=('x86_64' 'aarch64')
url="https://github.com/sateffen/coredns-ip-destination-guard"
license=('MIT')
backup=('etc/coredns-ip-destination-guard/Corefile')
source=(coredns-${pkgver}.tar.gz::https://github.com/coredns/coredns/archive/v${pkgver}.tar.gz
  coredns-ip-destination-guard.service
  Corefile
  plugin.cfg)

sha256sums=(
  '8a9f8729476bdf265d5990dea86c314db778aec2f79d3d47e43607903f7d0b37'
  '2b42e692f37925388d7bb8b5c30cf20b35f634ed3478c6c81b2a4c3e19ec20d1'
  '3039abf35dc2e7a025572bd12c42e4ebbc75366f95db0a3be6581cff89d4ca33'
  'cb6abe403b070a30778a8710ce2cd6f6998f0f011bf19bd6fe430cc807cc4898')

prepare() {
  export GOPATH="$srcdir/build"
  export GOFLAGS="-buildmode=pie -trimpath -ldflags=-linkmode=external -mod=readonly -modcacherw"

  cd "coredns-$pkgver"
  go mod download
}

build() {
  export GOPATH="$srcdir/build"
  # export PATH=$GOPATH/bin:$PATH
  export CGO_CPPFLAGS="${CPPFLAGS}"
  export CGO_CFLAGS="${CFLAGS}"
  export CGO_CXXFLAGS="${CXXFLAGS}"
  export CGO_LDFLAGS="${LDFLAGS}"
  export GOFLAGS="-buildmode=pie -trimpath -ldflags=-linkmode=external -mod=readonly -modcacherw"

  cp plugin.cfg "coredns-$pkgver"

  cd "coredns-$pkgver"
  make coredns
}

package() {
  install -Dm755 "$srcdir/coredns-$pkgver/coredns" "$pkgdir/usr/bin/coredns-ip-destination-guard"
  install -Dm644 "$srcdir/coredns-ip-destination-guard.service" "$pkgdir/usr/lib/systemd/system/coredns-ip-destination-guard.service"
  install -Dm644 "$srcdir/Corefile" "$pkgdir/etc/coredns-ip-destination-guard/Corefile"
  install -Dm644 "$srcdir/build/pkg/mod/github.com/sateffen/coredns-ip-destination-guard@"*"/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  install -Dm644 "$srcdir/coredns-$pkgver/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE-coredns"
}